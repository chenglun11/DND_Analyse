@startuml system_overview
!theme plain
title 地下城适配器系统架构总览

package "用户界面层" {
  [CLI命令行接口] as CLI
  [API接口] as API
}

package "核心管理层" {
  [适配器管理器] as AM
  [质量评估器] as QA
  [可视化器] as VI
}

package "数据转换层" {
  package "适配器插件" {
    [Watabou适配器] as WA
    [Donjon适配器] as DA
    [DungeonDraft适配器] as DDA
    [DD2VTT适配器] as DD2VTT
    [FiMap Elites适配器] as FEA
  }
  
  [空间推理引擎] as SI
  [数据模式] as SC
}

package "质量评估层" {
  package "评估规则插件" {
    [可访问性规则] as AR
    [度方差规则] as DVR
    [门分布规则] as DDR
    [死胡同比例规则] as DER
    [关键路径长度规则] as KPLR
    [环路比例规则] as LRR
    [路径多样性规则] as PDR
    [宝藏怪物分布规则] as TMDR
    [美学平衡规则] as ABR
  }
}

package "数据层" {
  [统一地下城格式] as UDF
  [各种源格式] as JSON
}

CLI --> AM
CLI --> QA
CLI --> VI

AM --> WA
AM --> DA
AM --> DDA
AM --> DD2VTT
AM --> FEA

AM --> SI
AM --> SC

QA --> AR
QA --> DVR
QA --> DDR
QA --> DER
QA --> KPLR
QA --> LRR
QA --> PDR
QA --> TMDR
QA --> ABR

WA --> UDF
DA --> UDF
DDA --> UDF
DD2VTT --> UDF
FEA --> UDF

SI --> UDF
SC --> UDF

AR --> UDF
DVR --> UDF
DDR --> UDF
DER --> UDF
KPLR --> UDF
LRR --> UDF
PDR --> UDF
TMDR --> UDF
ABR --> UDF

JSON --> WA
JSON --> DA
JSON --> DDA
JSON --> DD2VTT
JSON --> FEA
@enduml

@startuml adapter_architecture
!theme plain
title 插件适配器架构

package "适配器管理器 (AdapterManager)" {
  [动态加载器] as DM
  [格式检测器] as DF
  [转换器] as CV
}

package "适配器基类 (BaseAdapter)" {
  [抽象基类] as BA
  [format_name属性] as FN
  [detect方法] as DT
  [convert方法] as CN
  [convert_with_inference方法] as CI
}

package "具体适配器实现" {
  [WatabouAdapter] as WA
  [DonjonAdapter] as DA
  [DungeonDraftAdapter] as DDA
  [DD2VTTAdapter] as DD2VTT
  [FiMapElitesAdapter] as FEA
}

package "统一数据格式" {
  [UnifiedDungeonFormat] as UDF
  [Header信息] as HD
  [Levels数据] as LV
  [Rooms数据] as RM
  [Connections数据] as CN
  [Corridors数据] as CR
}

DM --> BA
DF --> BA
CV --> BA

BA --> WA
BA --> DA
BA --> DDA
BA --> DD2VTT
BA --> FEA

WA --> UDF
DA --> UDF
DDA --> UDF
DD2VTT --> UDF
FEA --> UDF

UDF --> HD
UDF --> LV
LV --> RM
LV --> CN
LV --> CR
@enduml

@startuml spatial_inference_flow
!theme plain
title 空间推理与图模型流程

package "输入数据" {
  [地下城数据] as DD
  [房间列表] as RM
  [走廊列表] as CR
  [连接信息] as CN
}

package "空间推理引擎 (SpatialInferenceEngine)" {
  [房间边界提取] as RB
  [邻接判断] as AD
  [置信度计算] as CF
  [门位置推断] as DP
}

package "图模型构建" {
  [连接图构建] as GR
  [拓扑分析] as TP
  [最短路径] as SP
  [连通分量] as CC
}

package "入口出口识别" {
  [语义分析] as SE
  [拓扑规则] as TR
  [空间位置] as SP2
  [智能识别] as ID
}

package "输出增强数据" {
  [增强数据] as ED
  [推断连接] as IC
  [推断门] as ID2
  [入口出口] as IE
}

DD --> RB
RM --> RB
CR --> RB

RB --> AD
AD --> CF
AD --> DP

CF --> GR
DP --> GR

GR --> TP
GR --> SP
GR --> CC

TP --> SE
SP --> TR
CC --> SP2

SE --> ID
TR --> ID
SP2 --> ID

ID --> ED
CF --> IC
DP --> ID2
ID --> IE

IC --> ED
ID2 --> ED
IE --> ED
@enduml

@startuml quality_assessment_pipeline
!theme plain
title 指标计算管道

package "输入数据" {
  [统一地下城格式] as UDF
  [空间推理结果] as SI
}

package "质量评估器 (DungeonQualityAssessor)" {
  [规则加载器] as LR
  [权重配置] as RW
  [质量评估] as AQ
}

package "评估规则管道" {
  package "结构规则 (35%)" {
    [可访问性规则] as AR
    [度方差规则] as DVR
    [门分布规则] as DDR
    [环路比例规则] as LRR
  }
  
  package "游戏性规则 (50%)" {
    [路径多样性规则] as PDR
    [宝藏怪物分布规则] as TMDR
    [死胡同比例规则] as DER
  }
  
  package "美学规则 (15%)" {
    [美学平衡规则] as ABR
  }
}

package "评分计算" {
  [加权求和] as WS
  [分类评分] as CS
  [总体评分] as OS
  [等级评定] as GR
}

package "输出结果" {
  [详细报告] as DR
  [改进建议] as RC
  [JSON输出] as JS
}

UDF --> AQ
SI --> AQ

AQ --> AR
AQ --> DVR
AQ --> DDR
AQ --> LRR
AQ --> PDR
AQ --> TMDR
AQ --> DER
AQ --> ABR

AR --> WS
DVR --> WS
DDR --> WS
LRR --> WS
PDR --> WS
TMDR --> WS
DER --> WS
ABR --> WS

WS --> CS
CS --> OS
OS --> GR

OS --> DR
CS --> RC
DR --> JS
RC --> JS
GR --> JS
@enduml 