# KeyPathLengthRule文档

## 概述

KeyPathLengthRule已更新为使用**0权重客观评分方法**，评估从入口到关键目标（如出口/Boss房）的最短路径长度，完全基于数学原理，无任何主观权重。

## 设计理念

### 客观性
- 完全基于图论和网络科学原理
- 无主观权重分配
- 使用几何平均融合，确保所有子指标平等贡献

### 子指标

#### 1. Raw Length（原始路径长度）
- **定义**: BFS算法计算的最短路径长度
- **意义**: 从入口到出口的实际步数

#### 2. Normalized Length（归一化长度）
- **定义**: raw_length / diameter
- **范围**: [0, 1]
- **意义**: 相对于图直径的路径长度，衡量路径的合理性

#### 3. Branch Factor（分支因子）
- **定义**: 1 - (非直线节点比例)
- **范围**: [0, 1]
- **意义**: 衡量路径的直线性，值越高表示路径越直线

### 融合方法

使用**几何平均**融合两个子指标：

```
score = exp(mean(log(factors)))
```

其中`factors`为所有非零子指标。

## 技术实现

### 核心算法

1. **BFS最短路径计算**
   - 从入口房间开始BFS
   - 计算到出口房间的最短路径
   - 同时生成全图距离映射

2. **图直径估计**
   - 基于BFS生成的距离表
   - 取最大距离作为图直径

3. **分支因子计算**
   - 分析路径上每个节点的分支情况
   - 计算非直线节点的比例

4. **统计归一化**
   - 基于图的直径进行归一化
   - 确保所有指标在[0,1]范围内

### 代码结构

```python
class KeyPathLengthRule(BaseQualityRule):
    def evaluate(self, dungeon_data):
        # 1. 构建图结构
        # 2. 确定入口和出口
        # 3. 计算最短路径
        # 4. 计算分支因子
        # 5. 归一化处理
        # 6. 几何平均融合
        return score, details
```

## 权重设置

- **当前权重**: 0.0
- **原因**: 使用客观评分方法，不参与主观权重计算
- **影响**: 不影响整体质量评分，仅提供客观分析

## 评分示例

### 高质量路径特征
- 归一化长度 ≈ 0.5-0.8（合理距离）
- 分支因子 > 0.5（相对直线）

### 低质量路径特征
- 归一化长度 > 0.9（路径过长）
- 分支因子 < 0.2（路径过于复杂）

## 入口出口识别

### 优先级策略
1. **标记识别**: 查找`type: 'entrance'`和`type: 'exit'`的房间
2. **位置识别**: 使用第一个房间作为入口，最后一个房间作为出口
3. **备用策略**: 基于连接度选择入口和出口

## 优势

1. **完全客观**: 无主观权重，基于纯数学原理
2. **理论严谨**: 基于图论和BFS算法
3. **易于理解**: 两个子指标含义明确
4. **稳定可靠**: 几何平均确保结果稳定

## 应用场景

- 关键路径长度评估
- 游戏流程设计分析
- 路径优化建议
- 客观比较不同地图设计

## 技术细节

### BFS算法优化
- 同时计算最短路径和全图距离
- 使用队列优化性能
- 支持大规模地图处理

### 分支因子计算
- 排除入口和出口节点
- 计算中间节点的分支情况
- 使用度数-2作为分支计数

### 错误处理
- 处理不可达情况
- 处理空图情况
- 处理无效入口出口 