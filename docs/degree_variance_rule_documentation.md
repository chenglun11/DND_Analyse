# DegreeVarianceRule文档

## 概述

DegreeVarianceRule已更新为使用**纯客观评分方法**，评估地图中房间度数分布的方差，完全基于数学原理，无任何主观权重。

## 设计理念

### 客观性
- 完全基于图论和统计学原理
- 无主观权重分配
- 使用理论最大方差进行归一化

### 子指标

#### 1. Raw Variance（原始方差）
- **定义**: 房间度数分布的实际方差
- **意义**: 衡量度数分布的离散程度

#### 2. Normalized Variance（归一化方差）
- **定义**: raw_variance / max_variance
- **范围**: [0, 1]
- **意义**: 相对于理论最大方差的归一化值

### 评分方法

使用**纯客观线性关系**：

```
score = 1.0 - normalized_variance
```

- 度数分布越均匀，评分越高
- 完全线性关系，无任何主观调整

## 技术实现

### 核心算法

1. **度数统计**
   - 基于connections统计每个房间的度数
   - 确保所有房间都被计入（包括孤立房间）

2. **方差计算**
   - 计算度数分布的均值和方差
   - 使用标准方差公式

3. **理论最大方差**
   - 当一半节点度数=0，另一半度数=n-1时达到最大
   - max_variance = ((n-1)/2)²

4. **归一化处理**
   - 将实际方差除以理论最大方差
   - 确保结果在[0,1]范围内

### 代码结构

```python
class DegreeVarianceRule(BaseQualityRule):
    def evaluate(self, dungeon_data):
        # 1. 构建度数映射
        # 2. 计算方差
        # 3. 计算理论最大方差
        # 4. 归一化处理
        # 5. 返回客观评分
        return score, details
```

## 权重设置

- **当前权重**: 0.08（参与主观权重计算）
- **原因**: 虽然使用客观评分，但仍参与整体权重计算
- **影响**: 影响整体质量评分

## 评分示例

### 高质量地图特征
- 度数分布均匀（如[4,4,4,4]）
- 原始方差接近0
- 评分接近1.0

### 低质量地图特征
- 度数分布极不均匀（如[7,2,2,4]）
- 原始方差接近理论最大值
- 评分接近0.0

## 理论最大方差推导

### 数学原理
对于n个节点的图，理论最大方差出现在：
- 一半节点度数为0
- 一半节点度数为n-1

### 计算过程
1. **均值**: mean = (n-1)/2
2. **方差**: var_max = ((n-1)/2)²

### 示例
- n=4时，max_variance = (3/2)² = 2.25
- n=5时，max_variance = (4/2)² = 4.0

## 优势

1. **完全客观**: 无主观权重，基于纯数学原理
2. **理论严谨**: 基于统计学和图论
3. **易于理解**: 线性关系，含义明确
4. **稳定可靠**: 理论最大方差确保归一化稳定

## 应用场景

- 度数分布均匀性评估
- 房间连接平衡性分析
- 地图拓扑结构优化建议
- 客观比较不同地图设计

## 技术细节

### 度数统计优化
- 使用defaultdict提高效率
- 支持大规模地图处理
- 自动处理孤立房间

### 方差计算
- 使用标准方差公式
- 处理边界情况（n=1）
- 数值稳定性保证

### 归一化处理
- 基于理论最大方差
- 确保结果在[0,1]范围
- 处理除零情况

### 错误处理
- 处理空图情况
- 处理无效连接
- 处理孤立节点 